<!DOCTYPE html>
<html>
<head>
   <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>  
   <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.3.2/jquery.min.js"></script>
   <script src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.7.2/jquery-ui.js"></script>
   <link href="css/bootstrap.css" rel="stylesheet">
      <link href="css/bodyCSS.css" rel="stylesheet">
   <link   rel="stylesheet" type="text/css"
           href="http://ajax.googleapis.com/ajax/libs/jqueryui/1.7.1/themes/base/jquery-ui.css"/><style>

*{
    margin : 0px;
    padding: 0px;
}

#container 
{
    position:relative;
}


#pin 
{
    position:absolute;
    left: 0px ;
    top: 0px ;
    width: 15px;
    height: 30px;
}

#map 
{
width: 160px;
height: 90px;
}
#map img 
{
width: 100%;
height: 100%;
}

</style>
</head>

<body>

<div id="container">
 
  <div id="map" >
  </div>    
  <div id =pin>
   <img src="pinpoint.png" id="pin" height="30" width="15"/>
  </div> 

</div>

<div id="footer" >
     
  <button class="btn btn-large btn-primary" name="button" value="OK" type="button" onclick="Position()">Start</button>   
  <button class="btn btn-large btn-primary" name="button" value="OK" type="button" onclick="offsetPinPosition()">Offset</button>
  <button class="btn btn-large btn-primary" name="button" value="OK" type="button" id="new">Map</button>    
     
</div>
 
<script>
  
  //To make map and pin resizable , draggable and droppable
  $(function() {
    $("#map").resizable();
    $("#map").draggable();
    $("#pin").draggable();
  });
  
  //To place the pin in (0,0)after the map resize


  function offsetPinPosition(){
    var mapX = $("#map").width();
    var mapY = $("#map").height();
    offPin=$("#map").offset();
    $("#pin").css({left: offPin.left, top: (offPin.top)+mapY-30});
  }

  //To call mapPosition()
  $(document).ready(function(){
    $('#new').click(function(){
          mapPosition();
   });
  });


  //Calculation to move the pin
  function Position()

{
offMap=$("#map").offset();

//Map id from the server
var id;

var watch_x= new Array();
var watch_y= new Array();

// Width and height after map resize, drag and drop
var x_map = $("#map").width();
var y_map = $("#map").height(); 

var x_room=6;
var y_room=6;

// Pin's <x,y> positions from server (JSON)         
var posX = new Array(); 
var posY = new Array();

var jsonURL="http://shironambd.com/api/v1/watch/?access_key=529a2d308333d14178f5c54d&format=json&limit=1";
var objLen;   



$.ajaxSetup({cache:false});
$.getJSON(
jsonURL,
  function(json){

  objLen=json.objects.length;

  //Last x and y position from server
  posX = json.objects[objLen-1].x;
  posY = json.objects[objLen-1].y;

  
  // pin's coordinates after scaling/offset 
  watch_x    = (posX * (x_map/x_room));
  watch_y    = (posY * (y_map/y_room));

  console.log("server X: ",posX);
  console.log("server Y: ",posY);
  console.log("watch X: ",watch_x);
  console.log("watch Y: ",watch_y);
  console.log("map left offset: ", $("#map").offset().left);
  console.log("map top offset: ", $("#map").offset().top);

  var pinTopCoord=$("#map").offset().top+$("#map").height()-watch_y-$("#pin").height();
  var pinLeftCoord=$("#map").offset().left+watch_x-$("#pin").width()/2;
  console.log('pin x position : ', pinLeftCoord);
  console.log('pin y position : ', pinTopCoord);


  //To make the pin to move
  $("#pin").css({left: pinLeftCoord, top: pinTopCoord}); 
});


 }

//To retrive map from server
 function mapPosition()
{ 

// Retriving map record from server

  var jsonURL1="http:shironambd.com/api/v1/map/?access_key=529a2d308333d14178f5c54d&format=json"
  var objLen;   


$.ajaxSetup({cache:false});
$.getJSON(
jsonURL1,
function(json){

objLen=json.objects.length;
//Extracting id 
var id = json.objects[objLen-1].id;
console.log("id: ",id);


var  string1= "http://shironambd.com/api/v1/image/?access_key=529a2d308333d14178f5c54d&id="  
var mapURL=string1 + id;

var img = $("<img />").attr('src', mapURL)
.load(function()
 {

 $("#map").append(img);
 }

 )});

}


</script>  




</body>
</html>
